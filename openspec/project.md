# Project Context

## Purpose

NovelGen 是一个**中文AI小说生成系统**，旨在自动化小说创作的全过程。项目将复杂的小说创作任务分解为6个结构化的步骤，利用大语言模型（LLM）生成世界观、角色、情节和完整文本，为中文创作者提供完整的AI辅助创作解决方案。

**核心目标：**
- 提供从概念到完整小说的端到端自动化生成
- 确保生成内容符合中文语境，避免翻译腔和西化表达
- 实现高度模块化和可配置的生成流程
- 保持角色一致性、世界观自洽性和情节连贯性

## Tech Stack

### 核心技术
- **Python 3.10+** - 主要编程语言
- **LangChain 1.0+** - AI应用框架，提供链式调用和提示词管理能力
- **OpenAI GPT 系列** - 核心语言模型（支持gpt-4, gpt-4o-mini, gpt-3.5-turbo等）
- **Pydantic 2.0+** - 数据验证、序列化和结构化输出管理

### 开发工具
- **uv** - 推荐的包管理器（替代pip）
- **dotenv** - 环境变量管理

## Project Conventions

### Code Style

**文件头部：**
- 每个文件必须包含中文docstring，说明模块功能
- 包含作者信息和时间（jamesenh, YYYY-MM-DD）

**命名规范：**
- 函数和变量使用英文snake_case命名
- 类名使用PascalCase
- 常量使用UPPER_SNAKE_CASE

**导入规范：**
- 标准库 → 第三方库 → 本地模块的顺序
- 使用绝对导入：`from novelgen.models import ...`

**注释规范：**
- 复杂逻辑必须添加中文注释
- 函数签名包含完整的docstring（Args, Returns, 功能描述）

### Architecture Patterns

**6步生成管道：**
每个步骤都是独立的LangChain模块，通过JSON文件进行通信
1. **World Creation** → 生成世界观
2. **Theme & Conflict** → 定义主题冲突
3. **Character Development** → 创建角色
4. **Outline Generation** → 构建大纲
5. **Chapter Planning** → 计划章节
6. **Text Generation** → 生成正文

**设计原则：**
- **链独立性**：每个链可独立运行和测试
- **JSON通信**：链间通过JSON文件传递数据，不直接调用
- **Pydantic优先**：所有输出必须经过Pydantic模型验证
- **配置化**：通过环境变量配置模型参数，支持链级单独配置
- **错误修复机制**：使用LLMJsonRepairOutputParser自动修复JSON格式错误

**文件组织：**
```
novelgen/
├── chains/         # LangChain生成链（业务逻辑 + LangChain代码）
├── runtime/        # 运行时工具（不包含LangChain）
├── models.py       # 所有Pydantic数据模型
├── config.py       # 配置管理
└── llm.py         # LLM实例管理
```

### Testing Strategy

**当前策略：**
- 主要依赖手动测试和演示流程验证
- 通过 `/projects/demo_001/` 和 `/projects/demo_002/` 示例项目进行完整性测试
- 观察生成过程的日志输出，检查JSON格式和内容质量

**测试重点：**
- JSON输出格式正确性
- Pydantic模型验证通过
- 生成内容连贯性和一致性
- 提示词执行效果

**建议改进方向：**
- 添加单元测试（特别是模型验证和配置加载）
- 添加集成测试（端到端生成流程）
- 添加性能测试（生成速度和token消耗）

### Git Workflow

**提交规范：**
- 使用中文撰写commit message
- 格式：`feat/fix/docs/refactor: 具体功能描述`
- 示例：`feat: 优化场景文本生成提示词，解决7个核心问题`

**分支策略：**
- main分支作为稳定分支
- 功能开发使用feature分支
- Pull Request需要审核（当前由开发者自行审核）

## Domain Context

### 中文创作专注
- **输出语言**：所有生成内容必须为简体中文
- **文化适配**：避免西方奇幻设定的直接翻译，融入东方文化元素
- **表达习惯**：使用中文母语者的自然表达方式，避免直译腔
- **引号规范**：使用「」或（）进行强调，或使用转义的\"避免JSON错误

### 小说创作知识
- **世界观设计**：需要详细的设定层级，涵盖地理、历史、社会、力量体系
- **角色弧光**：主角需有成长和变化，反派需要合理的动机
- **三幕结构**：章节大纲遵循经典的故事结构
- **场景设计**：每个场景需包含明确的目标、冲突和转折
- **节奏控制**：通过场景长度和复杂度控制阅读节奏

### 提示词工程要点
- **任务明确**：清晰说明AI的任务和输出目标
- **输入约束**：明确允许的输入格式和字段含义
- **输出格式**：严格定义JSON schema，减少歧义
- **注意事项**：避免常见错误（如格式问题、内容问题）

## Important Constraints

### 技术约束
- **依赖OpenAI API**：核心生成能力完全依赖OpenAI GPT模型
- **成本敏感**：高级模型（gpt-4）费用较高，需平衡质量和成本
- **网络稳定性**：需要稳定的网络连接访问OpenAI API
- **速率限制**：受OpenAI API的RPM和TPM限制
- **JSON严格性**：输出必须完全符合JSON格式，任何格式错误将导致后续链失败

### 业务约束
- **中文市场定位**：系统为中文创作优化，不适合其他语言
- **创意保护**：生成内容无法获得版权保护（AI生成）
- **内容安全**：依赖OpenAI的内容过滤机制，无法完全控制输出内容
- **生成质量波动**：LLM输出存在一定随机性，相同输入可能产生不同质量结果

### 系统约束
- **状态管理**：系统无数据库，使用JSON文件存储中间结果
- **无并发处理**：当前设计面向单次生成，不支持高并发
- **内存限制**：长文本生成可能消耗大量内存和token
- **无缓存机制**：重复生成会重新调用LLM（除非使用生成复用功能）

## External Dependencies

### 核心依赖
- **OpenAI API** - 小说内容生成的核心服务
  - 必需有效的API Key
  - 可用的模型访问权限（推荐使用gpt-4系列）
  - 建议监控使用情况和费用

### 可选依赖
- **兼容OpenAI API的服务** - 通过BASE_URL配置支持
  - Azure OpenAI Service
  - 第三方LLM代理服务
  - 本地部署的兼容服务（如vLLM, LocalAI）

### 环境要求
- Python 3.10+ 运行环境
- 网络访问能力（访问OpenAI API）
- 足够的磁盘空间存储生成内容（每个项目约10-100MB）
