## Why

当前 `ng chat` 的“对话式 Agent”虽然提供了自然语言意图识别、范围解析与澄清提问，但**缺少可用的多轮对话上下文机制**：

- 会话内并未可靠记录 user/assistant 的对话历史（代码中存在 `conversation_history` 但未消费/持久化）。
- 意图识别链（LLM + 规则融合）只基于“当轮输入”，未将对话历史一并提供给 LLM 进行指代消解、范围沿用、澄清回答解析。
- 澄清流程存在“只提问、不闭环”的断点：系统能提出澄清问题，但无法将用户的澄清回答合并回上一轮意图并继续执行。

这会导致：

- **意图理解不稳定**：对省略、指代、跟进式表达（如“按刚才那个来”“继续”“再生成正文”）容易误判或退化。
- **澄清能力失效**：用户必须重复完整需求，降低对话体验并增加误操作风险。
- **工具能力被间接削弱**：工具本身是确定性的，但缺少上下文会导致参数补全困难（章节范围、目标产物、模式 plan/text），从而影响工具调用的正确性与可控性。

因此需要把“对话上下文记录 + 澄清闭环 + 历史注入意图识别”作为 `ng chat` 的基础能力补齐，确保 Agent 的多轮交互能力与安全边界一致。

## What Changes

- **引入会话上下文管理（Conversation Context）**
  - 会话内记录 `user`/`assistant` 的对话轮次（含时间戳、消息内容、可选结构化元信息如 last_intent/last_scope）。
  - 提供可配置的窗口裁剪：只保留最近 N 轮或最大字符数；超过上限时可选生成“会话摘要”以保持长对话可用性。
- **将对话历史注入意图识别（LLM Intent w/ History）**
  - 扩展意图识别链输入：`user_input + chat_history (+ optional summary)`。
  - 明确优先级：当轮输入 > 历史补全；历史仅用于指代消解、范围沿用、缺参补齐，禁止覆盖当轮的明确约束。
  - 保留规则解析兜底：LLM 不可用/失败时仍可工作，并且不允许静默扩大执行范围。
- **实现澄清闭环（Clarification Loop Closure）**
  - 识别到歧义后进入“待澄清状态”，保存上一轮的 `ParsedIntent` 与问题/选项。
  - 下一轮输入如果匹配澄清回答（如 “1/2”，“章节正文”，“计划” 等），系统必须合并回意图并继续走“回显→确认→执行”流程。
  - 引入澄清次数上限与超时策略：避免无限追问；超过上限回退为显式选项指令或建议使用斜杠命令。
- **安全与隐私策略**
  - 默认仅在内存中保存会话历史；**不默认落盘**。
  - 可选开启落盘（用于调试/恢复会话），并提供最小化与脱敏策略（避免写入潜在敏感信息）。
- **文档与测试完善**
  - 补充多轮示例：澄清回答、范围沿用、跟进式表达。
  - 增加单元测试覆盖：澄清闭环、多轮 follow-up、历史窗口裁剪、LLM 失败回退行为。

## Impact

- **Affected specs（通过 spec deltas 更新）**
  - `agent-chat`：新增“会话上下文记录/裁剪”“历史注入意图识别”“澄清闭环”的要求与场景
  - `configuration`：新增 chat 上下文/裁剪/落盘相关配置项（环境变量或 ProjectConfig 字段）

- **Affected code（实现阶段将改动/新增）**
  - `novelgen/agent/chat.py`：接入会话上下文、澄清闭环、对话历史写入与复用
  - `novelgen/agent/intent_parser.py`：扩展 LLM 意图识别链输入（history + optional summary），并保留规则兜底
  - （可选）新增 `novelgen/agent/conversation_state.py`：集中管理会话状态模型与裁剪/摘要逻辑
  - `docs/对话式Agent使用指南.md`：补充多轮示例与配置说明
  - `tests/`：新增与更新 chat 相关回归测试

## Acceptance Checklist

- **会话历史记录（基础）**
  - 用户在一次 `ng chat` 会话中连续输入多轮自然语言，系统 MUST 记录 user/assistant 消息序列，并在需要时提供给意图识别链使用。
  - 系统 MUST 对历史进行裁剪（最近 N 轮或最大字符数）以控制成本与 token。

- **澄清闭环（必须可用）**
  - **WHEN** 用户输入“生成第3章”
  - **THEN** 系统 MUST 追问“章节计划 vs 章节正文”
  - **WHEN** 用户下一轮回复“2”（或“正文/章节正文”）
  - **THEN** 系统 MUST 将回答合并回上一轮意图（mode=text），回显理解结果并进入确认/执行流程

- **多轮 follow-up（历史注入）**
  - **WHEN** 用户输入“生成前3章的章节计划”并确认执行完成
  - **AND** 下一轮用户输入“再生成正文”（不显式给范围）
  - **THEN** 系统 MUST 能使用对话历史推断范围（1-3章）并提出确认回显；若无法确定 MUST 提问澄清而非误执行全量

- **LLM 不可用/失败兜底**
  - **WHEN** LLM 意图识别失败或关闭
  - **THEN** 系统 MUST 退回规则解析
  - **AND** 对于依赖历史才能完成的 follow-up，系统 MUST 提问澄清（而不是静默执行扩张范围的默认行为）

- **安全边界**
  - 默认不落盘会话历史；开启落盘时 MUST 具有最大长度/轮次限制与最小化策略。
  - 破坏性操作（如回滚/覆盖）仍 MUST 遵循既有确认策略，不因“历史推断”而降低确认门槛。

## Non-Goals（本提案不做）

- 不在本提案中引入“基于对话历史的自动执行”（例如把“好/继续”当作 `/yes`）以避免降低安全性与可控性。
- 不将对话历史作为“小说内容生成链”的上下文来源（本提案仅增强意图理解与对话决策层）；小说内容一致性仍以 JSON 真源与记忆上下文链为准。
- 不实现跨设备/多用户的会话同步与权限系统。

## Rollout Plan（建议）

1. **Phase 1：澄清闭环 + 内存历史窗口**（最小闭环，收益最大）
2. **Phase 2：LLM 意图识别注入 history + summary（可选）**
3. **Phase 3：可选落盘与调试工具（jsonl 导出/清理）**

