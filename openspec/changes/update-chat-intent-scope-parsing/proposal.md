## Why

当前 `ng chat` 自然语言意图识别为关键词版本，缺少对“约束/范围”的解析与校验。当用户输入包含明确范围的请求（例如“生成前3章的章节计划”）时，系统很可能：

- 只识别到“生成”动词，触发默认的全流程执行；或
- 即使识别到要生成“章节计划”，也无法识别“前3章”这一范围约束，导致生成默认的全量章节计划。

这类问题本质上是**意图识别缺少结构化约束抽取**，并且缺少“识别到约束但无法执行时的安全降级策略”，从而产生超出用户预期的执行范围与成本。

## What Changes

- **引入范围/约束抽取层**：在自然语言解析中，除了识别“动作/目标”，还要抽取并标准化：
  - 章节范围：前 N 章、第 M 章、第 M-N 章、从 M 到 N、到第 N 章之前等
  - 执行边界：仅生成到某阶段（world/theme/characters/outline/chapter_planning/…）
  - 模式：计划（plan）vs 正文（text）等易混淆目标
- **引入 LLM 意图识别（结构化输出）**：使用 LLM 将用户自然语言解析为结构化意图对象（含目标/范围/歧义标记/缺失信息），并与规则解析结果进行融合与校验。
- **歧义处理与追问策略**：当输入可被多种方式解释（如“生成第3章”可能指章节计划或章节正文），系统必须先澄清再执行。
- **约束感知的安全降级**：当系统识别到“范围约束”，但当前工具/工作流无法精确执行该范围时，系统必须：
  - 明确告知“当前不支持精确范围执行”
  - 提供选项（例如：改为生成全部章节计划/改用斜杠命令/先生成大纲后再指定章节）
  - 在用户确认前不得扩张为默认全量/全流程执行
- **可见的解析回显**：在执行前向用户回显“我理解你的请求为：目标=…，范围=…，将执行=…”，降低误判风险。

## Impact

- **Affected specs（通过 spec deltas 更新）**
  - `agent-chat`：新增“范围/约束抽取”“歧义澄清”“约束感知降级”的要求与场景

- **Affected code（实现阶段将改动/新增）**
  - `novelgen/agent/chat.py`：自然语言解析与确认策略增强
  - （可选）新增 `novelgen/agent/intent_parser.py`：集中管理规则解析与标准化（便于测试与迭代）
  - （可选）新增 `novelgen/agent/intent_llm.py`：LLM 意图识别链（Pydantic 结构化输出），在规则不足/歧义时启用
  - `docs/对话式Agent使用指南.md`：补充范围指令示例与限制说明

## Acceptance Checklist

以下清单用于验收“完整意图识别（LLM + 规则兜底）+ 范围/约束解析 + 安全降级”是否满足常见对话场景。标注为 **(本提案范围内)** 的必须在本变更完成后通过；标注为 **(依赖其他提案)** 的由对应变更负责。

- **路由与基础行为**
  - (本提案范围内) 输入以 `/` 开头（如 `/run`、`/status`、`/rollback 3`）时：直达工具路由，绕过 LLM 意图识别。
  - (本提案范围内) 任意自然语言请求：执行前回显“目标/范围/拟执行动作”，避免黑箱执行。

- **章节范围解析（计划/正文）**
  - (本提案范围内) “生成前3章的章节计划”：目标=章节计划；范围=1..3。
  - (本提案范围内) “生成第2-5章的章节计划/生成2到5章的章节计划”：范围=2..5（包含边界）。
  - (本提案范围内) “生成前三章的章节计划/生成第十章/第十二章到第十五章”：支持中文数字解析并标准化。
  - (本提案范围内) “生成第3章”：必须先澄清“章节计划 vs 章节正文”，未澄清前不执行生成动作。
  - (本提案范围内) “继续生成到第5章/把前三章都写完”：能够提取范围约束并回显（若执行能力不足，走安全降级）。

- **歧义澄清（多解输入）**
  - (本提案范围内) “把第三章做一下/继续到第5章/先把后面几章规划一下/把中间几章补上”：必须提出 1–3 个澄清问题补齐缺失信息（起止章、计划/正文等）。

- **约束感知降级（禁止静默扩张）**
  - (本提案范围内) 已解析到范围约束（如 1..3），但当前工具/工作流无法精确执行：必须明确告知限制并提供选项；用户确认前不得自动扩张为默认全量/全流程。

- **LLM 可靠性与兜底**
  - (本提案范围内) LLM 意图识别失败/不可用时：回退规则解析；仍不足则澄清提问；不允许直接执行扩张范围的默认动作。

- **前置补齐确认（目标型生成）**
  - (依赖其他提案) “生成人物角色/生成章节计划(前三章)/生成第3章正文”在前置缺失时：先询问是否允许补齐前置，再按用户确认执行并 `stop_at` 停在目标节点（由 `update-chat-targeted-generation` 覆盖）。

## Non-Goals（本提案不做）

- 不承诺所有范围都能被工作流精确执行；若运行时能力缺失，优先做“正确识别 + 不误执行 + 引导选项”
- 不在本提案中优化 LLM 成本/延迟到极致（可通过模型选择与缓存作为后续优化项）
