# 知识图谱使用指南（Kùzu）

NovelGen 的知识图谱层使用 Kùzu（嵌入式图数据库）在每个项目内维护“角色/关系/事件/章节”等结构化信息，用于快速检索与对话式 Agent 的 `/whois`、`/relations`、`/events` 等命令。

## 1. 启用与目录

- 默认启用：`NOVELGEN_GRAPH_ENABLED=true`
- 关闭：`NOVELGEN_GRAPH_ENABLED=false`
- 默认目录：`projects/<project_id>/data/graph/`
- 覆盖目录：`NOVELGEN_GRAPH_DIR=<path>`

## 2. 图谱数据从哪里来

- 初始化角色/关系：来自 `projects/<project>/characters.json`
- 章节/事件增量更新：在 `chapter_memory.json` 写入成功后触发（失败不阻断主流程）

说明：
- 图谱是辅助层：即使图谱不可用，生成流程仍可运行。
- 图谱可从 JSON 重建（见下一节）。

## 3. 重建与查询（CLI）

重建（推荐在首次使用图谱或图谱损坏时执行）：

```bash
ng graph rebuild <project_id>
```

查询示例：

```bash
ng graph whois <project_id> 林风
ng graph relations <project_id> 林风 --with 师父
ng graph events <project_id> 林风
ng graph stats <project_id>
```

## 4. 与对话式 Agent 配合

在 `ng chat <project>` 中可用：

- `/whois <角色名>`
- `/relations <角色名> [--with <角色名>]`
- `/events <角色名>`

若提示“图谱不可用/暂无角色数据”，优先尝试：

1) `ng graph rebuild <project>`
2) 确认安装依赖与开关：`kuzu`、`NOVELGEN_GRAPH_ENABLED`
