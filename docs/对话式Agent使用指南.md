# 对话式 Agent 使用指南（ng chat）

对话式 Agent 是一个"对话决策层"，通过工具调用来驱动工作流运行、偏好管理、图谱查询与记忆检索。

## 启动

```bash
ng chat <project_id>
```

## 两种交互方式

### 1) 斜杠命令（确定性、推荐）

**工作流命令：**
- `/status`：查看项目状态
- `/run`：开始生成完整小说（默认需要确认）
- `/resume`：从检查点继续（默认需要确认）
- `/export`：导出为文本
- `/rollback N`：回滚到第 N 章之前（破坏性操作，始终需要确认）

**图谱查询：**
- `/whois <角色名>`：角色信息（需图谱可用）
- `/relations <角色名> [--with <角色名>]`：关系查询
- `/events <角色名>`：事件查询

**偏好管理：**
- `/setpref <偏好内容>`：写入项目偏好（需 Mem0 启用）
- `/prefs`：列出项目偏好
- `/forget <关键词>`：删除包含关键词的偏好（默认需要确认）

**审查与修订：**
- `/pending`：列出所有 pending 状态的修订
- `/review <章节号>`：查看章节的逻辑审查报告
- `/fix <章节号>`：为章节生成修订候选（需要确认）
- `/accept <章节号>`：应用修订，替换原章节（破坏性，始终需要确认）
- `/reject <章节号> [原因]`：拒绝修订，解除阻断（需要确认）

**会话控制：**
- `/auto on|off`：开关自动确认（破坏性操作仍需确认）
- `/yes`、`/no`：确认/取消待执行操作
- `/help`：帮助
- `/exit`：退出

### 2) 自然语言

自然语言意图识别支持 LLM + 规则双引擎：
- **LLM 引擎**：语义理解更准确，支持复杂表达
- **规则引擎**：作为 LLM 的兜底，确保关键功能可用

#### 全流程生成

说「开始生成」「继续生成」「一键生成」等会触发完整工作流，从当前状态一直执行到所有章节生成完毕。

```
你: 开始生成
助手: 📝 准备开始生成完整小说...
```

#### 目标型生成（推荐用于分步调试）

说「生成X」会触发**目标型生成**，系统只执行到指定阶段后停止，不继续执行后续节点。

支持的目标产物：
| 关键词 | 对应节点 |
|-------|---------|
| 世界观、世界、背景 | `world_creation` |
| 主题、主题冲突、冲突 | `theme_conflict_creation` |
| 人物、角色、人物角色 | `character_creation` |
| 大纲、故事大纲 | `outline_creation` |
| 章节计划、场景计划 | `chapter_planning` |

**示例对话：**

```
你: 生成人物角色
助手: 📋 **目标型生成计划**

🎯 目标产物：**人物角色**

⚠️ 检测到缺失前置步骤：
  - 世界观, 主题冲突

执行计划：
  1. 自动补齐缺失前置
  2. 生成人物角色
  3. 在 `character_creation` 停止（不继续后续步骤）

⏳ 输入 /yes 确认执行，/no 取消

你: /yes
助手: ✅ **人物角色** 生成完成
```

**注意事项：**
- 目标型生成的「补齐前置」确认 **不受 `/auto on` 影响**，始终需要用户显式确认
- 如果用户取消（`/no`），系统会提供替代建议

#### 带范围的生成（章节范围约束）✨

系统能够识别并解析自然语言中的章节范围约束，并**精确执行**指定范围的生成：

**支持的范围格式：**
| 示例 | 解析结果 |
|------|---------|
| 前3章 / 前三章 | 第1-3章 |
| 第5章 / 第五章 | 第5章 |
| 第2-5章 / 2到5章 | 第2-5章 |
| 第十二章到第十五章 | 第12-15章 |

**示例对话（章节计划）：**

```
你: 生成前3章的章节计划
助手: 📖 **理解你的请求**：目标=章节计划；范围=第1-3章

⏳ 即将执行精确范围生成...

你: /yes
助手: ✅ 生成 3 章计划，跳过 0 章（已存在）
```

**示例对话（章节正文）：**

```
你: 生成第2-5章的正文
助手: 📖 **理解你的请求**：目标=章节正文；范围=第2-5章

⏳ 即将执行精确范围生成...

你: /yes
助手: ✅ 生成 4 章正文，共 12,345 字
```

**核心语义约束：**
| 参数 | 默认值 | 说明 |
|------|-------|------|
| `missing_only` | `true` | 只生成缺失的章节，已存在的不覆盖 |
| `force` | `false` | 设为 `true` 时强制覆盖已存在内容 |
| `sequential` | `true`（仅正文） | 正文生成强制顺序约束，跳章会被阻断 |

**顺序约束示例：**

```
你: 生成第5章正文
助手: ❌ **顺序约束**

无法跳过生成：第 1-4 章正文缺失

建议：先生成第 1-4 章正文，或设置 sequential=false（不推荐）
```

**关键特性：**
- **精确执行**：请求生成第 2-5 章只处理 2-5 章，**不会静默扩张范围**
- **执行前回显**：系统会在执行前展示理解的意图（目标、范围、模式），提高透明度
- **智能跳过**：已存在的章节自动跳过（`missing_only` 默认开启）
- **顺序保护**：正文生成默认强制顺序，防止上下文断裂

#### 歧义澄清（支持闭环回答）✨

当输入存在歧义时，系统会要求用户澄清。系统支持**澄清闭环**：用户的回答会被合并回原意图并继续执行。

**常见歧义场景：**
- 「生成第3章」→ 章节计划还是章节正文？
- 「把后面几章规划一下」→ 具体是哪几章？

**示例对话（澄清闭环）：**

```
你: 生成第3章
助手: ❓ **需要更多信息**

原因：「生成第N章」可能指章节计划或章节正文

**问题 1**: 你想生成第3章的什么内容？
  1. 章节计划（详细场景规划）
  2. 章节正文（完整文本内容）

请回复具体选项或详细说明你的需求。

你: 2
助手: 📖 **理解你的请求**：目标=章节正文；范围=第3章

📋 **生成计划**
...
⏳ 输入 /yes 确认执行，/no 取消

你: /yes
助手: ✅ **章节正文生成完成**
```

**回答方式：**
- 数字选项：「1」「2」
- 关键词：「计划」「正文」「章节计划」「章节正文」
- 同义表达：「规划」「内容」

**澄清次数上限：**
系统默认最多追问 3 次。超过上限后会建议使用更明确的表达或斜杠命令。

#### 多轮 follow-up（范围沿用）✨

系统支持从**对话历史**中推断缺失参数。当你使用"再"、"继续"等 follow-up 表达时，系统会尝试沿用上一轮的范围。

**示例对话：**

```
你: 生成前3章的章节计划
助手: ...
⏳ 输入 /yes 确认执行，/no 取消

你: /yes
助手: ✅ **章节计划生成完成**
📝 已生成: 第 1, 2, 3 章

你: 再生成正文
助手: 📖 **理解你的请求**：目标=章节正文；范围=第1-3章

📋 **生成计划**
将调用 `chapter.text.generate` 生成指定范围的章节正文...
⏳ 输入 /yes 确认执行，/no 取消
```

**关键约束：**
- **当轮输入优先**：如果当轮明确指定了范围（如「第5章」），不会使用历史范围
- **不确定时澄清**：如果无法从历史推断，系统会主动提问而非静默扩张范围

### 逻辑审查质量闸门 ✨

当 `logic_review_policy` 设为 `"blocking"` 时，系统会在每章生成后自动进行逻辑审查。如果评分低于阈值或发现高严重性问题，将触发阻断，阻止后续章节的生成。

#### 配置

在 `settings.json` 中配置：

```json
{
  "logic_review_policy": "blocking",
  "logic_review_min_score": 75
}
```

或通过环境变量：
- `NOVELGEN_LOGIC_REVIEW_POLICY`: `"off"` (默认) 或 `"blocking"`
- `NOVELGEN_LOGIC_REVIEW_MIN_SCORE`: 最低通过分数 (默认 75)

#### 阻断条件

满足以下任一条件时触发阻断：
1. `overall_score < logic_review_min_score`
2. 存在 `severity == "high"` 的问题

#### 处理阻断

当阻断发生时，系统会：
1. 生成逻辑审查报告：`projects/<project>/reviews/chapter_XXX_logic_review.json`
2. 创建修订状态文件：`projects/<project>/chapters/chapter_XXX_revision.json`（状态为 `pending`）
3. 阻止后续章节生成，直到 pending 状态被处理

**示例对话（阻断处理）：**

```
助手: 🛑 **质量闸门阻断**

第 3 章存在 pending 修订，无法继续生成后续章节。

📄 修订状态文件：projects/demo_001/chapters/chapter_003_revision.json
📄 逻辑审查报告：projects/demo_001/reviews/chapter_003_logic_review.json
📝 修订说明：评分 62，存在因果链断裂问题...

💡 可选操作：
  1. /review 3 - 查看审查报告
  2. /fix 3 - 生成修订候选
  3. /accept 3 - 应用修订
  4. /reject 3 - 拒绝修订（跳过阻断）

你: /review 3
助手: 📋 **第 3 章逻辑审查报告**

评分: 62/100
问题: 2 个（高严重性 1 个）

🔴 [high] 因果断裂
   描述：主角突然获得神秘力量，但前文缺乏铺垫...
   建议：在前一场景中添加伏笔...

🟡 [medium] 节奏失衡
   描述：对话过于冗长，影响情节推进...

你: /fix 3
助手: 🔧 正在为第 3 章生成修订候选...

✅ 第 3 章修订候选已生成，共 2,850 字

下一步：
- /accept 3 - 应用修订
- /reject 3 - 拒绝修订（跳过阻断）

你: /accept 3
助手: ⚠️ 确定要应用第 3 章的修订候选吗？原章节将被备份。
输入 /yes 确认，/no 取消

你: /yes
助手: ✅ 第 3 章修订已应用
📦 原章节备份：projects/demo_001/chapters/chapter_003_backup.json

💡 阻断已解除，可继续生成后续章节
```

#### 拒绝修订（跳过阻断）

如果你认为审查报告的问题不重要，可以直接拒绝修订：

```
你: /reject 3 问题不影响阅读体验
助手: ⏭️ 第 3 章修订已拒绝，阻断已解除

💡 可继续生成后续章节
```

**注意**：拒绝修订不会修改原章节，只是将修订状态设为 `rejected`，解除阻断。

#### LLM 失败/禁用时的行为

当 LLM 意图识别不可用（网络问题、API 限制等）时：
- 系统自动回退到**规则解析**
- 基础功能（斜杠命令、明确的关键词表达）仍可正常工作
- 依赖历史的 follow-up 场景会**主动提问澄清**，而非静默执行

#### 其他自然语言

- "林风是谁？" → 图谱查询
- "查看当前进度" → 状态查询

说明：
- 图谱问答依赖图谱数据已构建：如提示图谱不可用/无数据，先在终端运行 `ng graph rebuild <project>` 再进入对话。

## 确认机制与环境变量

- 默认策略：生成/回滚/删除偏好等动作会要求确认
- `/auto on`：关闭"普通确认"（仍保留破坏性确认和目标型生成的前置补齐确认）

相关环境变量（见 `docs/ENV_SETUP.md`）：
- `NOVELGEN_CHAT_CONFIRM_DEFAULT`
- `NOVELGEN_CHAT_MAX_TOOL_CALLS`
- `NOVELGEN_CHAT_RETRIEVAL_MAX_ATTEMPTS`

## 会话上下文配置

系统支持多轮对话上下文管理，可通过以下环境变量配置：

| 环境变量 | 默认值 | 说明 |
|---------|-------|------|
| `CHAT_MAX_TURNS` | `10` | 最大保留轮次 |
| `CHAT_MAX_CHARS` | `4000` | 最大保留字符数 |
| `CHAT_PERSIST_ENABLED` | `false` | 是否启用会话历史落盘 |
| `CHAT_PERSIST_MAX_LINES` | `1000` | 落盘文件最大行数 |
| `CHAT_MAX_CLARIFICATION_ATTEMPTS` | `3` | 最大澄清次数 |

**落盘说明：**
- 默认**不落盘**会话历史，会话退出即丢失
- 启用落盘后，历史写入 `projects/<project_id>/chat_history.jsonl`
- 落盘内容经过脱敏处理（替换疑似 API Key 等敏感信息）

## 意图识别配置

系统默认使用 LLM + 规则双引擎进行意图识别：

- LLM 意图识别用于语义理解复杂表达
- 规则解析作为兜底，确保基础功能可用
- 当 LLM 不可用或调用失败时，自动回退到规则解析

**注意**：LLM 意图识别会产生额外的 API 调用开销。如需禁用，可在 Agent 初始化后设置：

```python
agent.use_llm_intent = False
```

## 扩展工具（开发者）

工具集中在 `novelgen/tools/`，注册入口在 `novelgen/agent/chat.py` 的 `ChatAgent._register_all_tools()`：

- 新增一个工具文件（参考 `workflow_tools.py` / `graph_tools.py`）
- 在 `_register_all_tools()` 中注册
- 为工具配置 `slash_command` 与 `confirm_level`

### 细粒度工具（Fine-Grained Tools）

Phase A 实现的细粒度工具支持精确范围执行：

| 工具名 | 功能 | 关键参数 |
|--------|------|---------|
| `project.status` | 项目状态 | `detail` |
| `project.validate_prereqs` | 前置验证 | `target` |
| `project.list_artifacts` | 列出产物 | `kind`, `chapter_scope_*` |
| `settings.get` | 获取设置 | - |
| `settings.update` | 更新设置 | `patch`, `persist` |
| `outline.generate` | 生成大纲 | `num_chapters`, `force` |
| `outline.extend` | 扩展大纲 | `additional_chapters`, `force` |
| `chapter.plan.generate` | 生成章节计划 | `chapter_scope_*`, `force`, `missing_only` |
| `chapter.text.generate` | 生成章节正文 | `chapter_scope_*`, `force`, `missing_only`, `sequential` |

**工具契约（必须遵守）：**
1. **JSON 为真源**：所有工具直接读写 `projects/<project_id>/` 下的 JSON 文件
2. **`missing_only` 语义**：默认只补缺，不覆盖已存在内容
3. **`force` 语义**：显式指定时覆盖已存在内容
4. **`sequential` 约束**：章节正文默认强制顺序生成
5. **无静默范围扩张**：请求生成第 2-5 章只处理 2-5 章

## 意图解析器扩展（开发者）

意图解析逻辑集中在 `novelgen/agent/intent_parser.py`：

- `parse_chapter_scope()`：章节范围解析
- `parse_intent_by_rules()`：规则解析
- `parse_intent_by_llm()`：LLM 意图识别（支持历史注入）
- `parse_intent()`：混合解析入口
- `format_chat_history_for_prompt()`：格式化历史用于 LLM

扩展新的范围格式或意图类型时，优先在规则解析中添加支持，确保无 LLM 时也能正常工作。

## 会话状态管理（开发者）

会话状态逻辑集中在 `novelgen/agent/conversation_state.py`：

- `ChatMessage`：单条消息模型
- `ConversationState`：会话状态管理（含裁剪/摘要/落盘）
- `PendingClarification`：澄清闭环状态
- `LastExecutedIntent`：最近执行的意图（用于 follow-up）
- `ConversationConfig`：会话配置（从环境变量读取）

**状态机说明：**

```
[Idle] ---(歧义检测)---> [AwaitingClarification]
                              |
                              +--(回答可解析)--> [Idle] + 执行
                              |
                              +--(回答不可解析)--> 重复提问
                              |
                              +--(超过次数上限)--> [Idle] + 建议明确表达
```
